name: Performance

on:
  pull_request:
    branches: [main, master]

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: "./lighthouserc.json"
          uploadArtifacts: true
          temporaryPublicStorage: true

  bundle-analysis:
    name: Bundle Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build and analyze bundle
        run: |
          npm run build
          npm run size

      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const distDir = './dist';
            let totalSize = 0;
            const files = [];

            function walkDir(dir) {
              const items = fs.readdirSync(dir);
              for (const item of items) {
                const fullPath = path.join(dir, item);
                const stat = fs.statSync(fullPath);
                if (stat.isDirectory()) {
                  walkDir(fullPath);
                } else {
                  const size = stat.size;
                  totalSize += size;
                  files.push({ name: fullPath.replace('./dist/', ''), size });
                }
              }
            }

            if (fs.existsSync(distDir)) {
              walkDir(distDir);
            }

            const formatSize = (bytes) => {
              if (bytes < 1024) return `${bytes} B`;
              if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
              return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
            };

            const jsFiles = files.filter(f => f.name.endsWith('.js')).sort((a, b) => b.size - a.size);
            const cssFiles = files.filter(f => f.name.endsWith('.css')).sort((a, b) => b.size - a.size);

            let body = '## ðŸ“¦ Bundle Size Report\n\n';
            body += `**Total Size:** ${formatSize(totalSize)}\n\n`;

            if (jsFiles.length > 0) {
              body += '### JavaScript Files\n';
              body += '| File | Size |\n';
              body += '|------|------|\n';
              for (const file of jsFiles.slice(0, 10)) {
                body += `| \`${file.name}\` | ${formatSize(file.size)} |\n`;
              }
              body += '\n';
            }

            if (cssFiles.length > 0) {
              body += '### CSS Files\n';
              body += '| File | Size |\n';
              body += '|------|------|\n';
              for (const file of cssFiles.slice(0, 5)) {
                body += `| \`${file.name}\` | ${formatSize(file.size)} |\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
